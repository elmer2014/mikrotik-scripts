#
:if ([:len [queue tree find name="DL-root"]] = 0) do={queue tree add name="DL-root" parent=global-out limit-at=0 priority=8 max-limit=19M burst-limit=0 burst-threshold=0 burst-time=0s;}
:if ([:len [queue tree find name="UL-root"]] = 0) do={queue tree add name="UL-root" parent=global-out limit-at=0 priority=8 max-limit=19M burst-limit=0 burst-threshold=0 burst-time=0s;}
queue tree add parent=DL-root max-limit=19M name="DLx-per-ip" priority=8 queue=default;
queue tree add parent=UL-root max-limit=19M name="ULx-per-ip" priority=8 queue=default;

ip fir mangle add chain=prerouting dst-address=207.97.192.0/18 action=mark-packet new-packet-mark="to-github" passthrough=no; 
queue tree add parent=UL-root limit-at=15M max-limit=19M name="UL-to-github" packet-mark="to-github" priority=3 queue=wireless-default;
ip fir mangle add chain=prerouting src-address=207.97.192.0/18 action=mark-packet new-packet-mark="from-github" passthrough=no; 
queue tree add parent=DL-root limit-at=15M max-limit=19M name="DL-from-github" packet-mark="from-github" priority=3 queue=wireless-default;

:foreach i in=[/int wir reg find] do={
    :local ip [/int wir reg get $i last-ip];:if ([:len $ip] > 0) do={
            :if ([:len [ip fir mangle find dst-address=$ip]] = 0) do={
                    ip fir mangle add chain=prerouting dst-address=$ip action=mark-packet new-packet-mark="DL-$ip" passthrough=no; queue tree add parent=DLx-per-ip limit-at=5M max-limit=7M name="DLQ-$ip" packet-mark="DL-$ip" priority=8 queue=default;
            }
            :if ([:len [ip fir mangle find src-address=$ip]] = 0) do={
                    ip fir mangle add chain=prerouting src-address=$ip action=mark-packet new-packet-mark="UL-$ip" passthrough=no; queue tree add parent=ULx-per-ip limit-at=5M max-limit=7M name="ULQ-$ip" packet-mark="UL-$ip" priority=8 queue=default
            }
        }
}
